We can design a complex microgrid system with:  

1. **Solar PV System** – Primary power generation  
2. **Wind Turbine** – Additional renewable source  
3. **Battery Storage System** – Stores excess energy  
4. **Diesel Generator** – Backup power source  
5. **Loads (Residential/Industrial)** – Power demand  
6. **Grid Connection (Optional)** – Allows power exchange  
7. **Power Converters (Inverters, DC/DC Converters)** – Ensures proper voltage levels  
8. **Control System (LQR, MPC, PID, Droop Control)** – Optimizes power flow  

### **State-Space Model for a Multi-Source Microgrid**
For this, let's define:
- **State variables:**  
  - \( x_1 = V_{dc} \) (DC Bus Voltage)  
  - \( x_2 = I_{batt} \) (Battery Current)  
  - \( x_3 = I_{solar} \) (Solar Current)  
  - \( x_4 = I_{wind} \) (Wind Current)  
- **Control Inputs:**  
  - \( u_1 = P_{solar} \) (Solar Power Input)  
  - \( u_2 = P_{wind} \) (Wind Power Input)  
  - \( u_3 = P_{diesel} \) (Diesel Generator Input)  
  - \( u_4 = P_{grid} \) (Power Exchange with Grid)  
- **Output:**  
  - \( y = V_{dc} \) (DC Bus Voltage)  

#### **State Equations**
\[
\begin{aligned}
\dot{x}_1 &= -\frac{1}{C_{dc}} (x_2 + x_3 + x_4 - u_1 - u_2 - u_3 - u_4) \\
\dot{x}_2 &= \frac{1}{L_b} (V_{dc} - R_b x_2) \\
\dot{x}_3 &= \frac{1}{L_s} (V_{dc} - R_s x_3) \\
\dot{x}_4 &= \frac{1}{L_w} (V_{dc} - R_w x_4) \\
\end{aligned}
\]

### **MATLAB Code for Multi-Source Microgrid**
```matlab
clc; clear; close all;

% Microgrid Parameters
C_dc = 1e-3; % DC Bus Capacitance (F)
L_b = 2e-3; % Battery Inductance (H)
L_s = 1e-3; % Solar Inductance (H)
L_w = 1.5e-3; % Wind Inductance (H)
R_b = 0.1; % Battery Resistance (Ohm)
R_s = 0.05; % Solar Resistance (Ohm)
R_w = 0.08; % Wind Resistance (Ohm)

% State-Space Model
A = [-1/C_dc, -1/C_dc, -1/C_dc, -1/C_dc;
      1/L_b, -R_b/L_b, 0, 0;
      1/L_s, 0, -R_s/L_s, 0;
      1/L_w, 0, 0, -R_w/L_w];

B = [1/C_dc, 1/C_dc, 1/C_dc, 1/C_dc;
     0, 0, 0, 0;
     0, 0, 0, 0;
     0, 0, 0, 0];

C = [1, 0, 0, 0]; % Output: DC Bus Voltage
D = [0, 0, 0, 0];

% System Definition
sys = ss(A, B, C, D);

% Simulation Parameters
t = 0:0.01:10; % 10 sec simulation
U = [500 400 200 100]; % Inputs (P_solar, P_wind, P_diesel, P_grid)

% Initial Conditions
x0 = [48; 0; 0; 0]; % Initial [Vdc, Ibatt, Isolar, Iwind]

% Simulate
[y, t, x] = lsim(sys, repmat(U, length(t), 1), t, x0);

% Plot Results
figure;
subplot(2,1,1);
plot(t, x(:,1), 'r', 'LineWidth', 2);
xlabel('Time (s)'); ylabel('DC Bus Voltage (V)');
title('Microgrid Voltage Response');
grid on;

subplot(2,1,2);
plot(t, x(:,2), 'b', 'LineWidth', 2);
hold on;
plot(t, x(:,3), 'g', 'LineWidth', 2);
plot(t, x(:,4), 'm', 'LineWidth', 2);
xlabel('Time (s)'); ylabel('Currents (A)');
title('Battery, Solar, Wind Currents');
legend('Battery', 'Solar', 'Wind');
grid on;
```

### **Applying Control Algorithm (LQR)**
```matlab
% LQR Control
Q = diag([100, 10, 10, 10]); % State Cost
R = eye(4) * 0.01; % Control Cost
K = lqr(A, B, Q, R);

% Closed-Loop System
Acl = A - B*K;
sys_cl = ss(Acl, B, C, D);

% Simulate Closed-Loop Response
[y_cl, t, x_cl] = lsim(sys_cl, repmat(U, length(t), 1), t, x0);

% Plot Closed-Loop Response
figure;
plot(t, x_cl(:,1), 'g', 'LineWidth', 2);
xlabel('Time (s)');
ylabel('DC Bus Voltage (V)');
title('Closed-Loop Voltage Regulation (LQR)');
grid on;
```

---

### **Conclusion**
✅ We **extended the microgrid** with:
- Solar PV, Wind, Battery, Diesel Generator, and Grid  
- DC Bus Voltage as the main regulated output  

✅ We **modeled** the microgrid using a **state-space system**  

✅ We **applied LQR control** to **stabilize DC bus voltage**  

Would you like to implement **Model Predictive Control (MPC)** or add **fault detection and energy management**?
